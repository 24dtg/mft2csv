#summary Extract $MFT record info and log it to a csv file.

= Introduction =

This AutoIt script is parsing, decoding and logging information from the Master File Table ($MFT) to a csv. It is logging a large amount of data and that has been the main purpose from the very start. Having all this data in a csv is therefore nice for easy further analysis. What also should make it appealing is the easyness of understanding the script and the ability for easy customization of it. 

= Details =

Input can be any of the following:
  * Raw/dd image of disk (MBR and GPT supported)
  * Raw/dd image of partition
  * $MFT extracted file
  * Reading of $MFT directly from a live system
  * $MFT fragments extracted off memory dumps (see MFTCarver)

There is an option to choose which UTC region to decode for. For instance you have a disk image and the target system had a timezone configuration of UTC -9.30, then you can configure it like that and get the timestamps directly into UTC 0.00. Default is UTC 0.00, and if running on a live system, there is no need to do anything as timestamps are automatically set to UTC 0.00. 

The format of output can be chosen. Currently it is possible to choose from:
  * All (will write to csv everything it can). Default set.
  * log2timeline: http://code.google.com/p/log2timeline/wiki/l2t_csv
  * bodyfile (v3.x): http://wiki.sleuthkit.org/index.php?title=Body_file

It is possible to parse broken/partial $MFT by configuring "Broken $MFT". This setting is necessary if for instance index number 0 is missing (the record for $MFT itself).

Also it is possible to configure the tool to skip fixups. This is something you may want if you are working on memory dumps. If so, you need to run MFTCarver on the memdump first. Then run mft2csv on the output file from MFTCarver. Must have both "Broken $MFT" and "Skip Fixups" configured in such a case.

The focus have been on the attributes $STANDARD_INFORMATION, $FILE_NAME, $DATA and $VOLUME_ID as well as the file record headers themselves. More attributes will be added for sure.  Here is the listing of data that is currently covered (more descriptive names may be chosen in the future);
  * RecordOffset
  * Signature
  * IntegrityCheck
  * HEADER_MFTREcordNumber
  * HEADER_SequenceNo
  * FN_ParentReferenceNo
  * FN_ParentSequenceNo
  * FN_FileName
  * HEADER_Flags
  * RecordActive
  * FileSizeBytes
  * SI_FilePermission
  * FN_Flags
  * FN_NameType
  * ADS
  * SI_CTime
  * SI_ATime
  * SI_MTime
  * SI_RTime
  * MSecTest
  * FN_CTime
  * FN_ATime
  * FN_MTime
  * FN_RTime
  * CTimeTest
  * FN_AllocSize
  * FN_RealSize
  * SI_USN
  * DATA_Name
  * DATA_Flags
  * DATA_LengthOfAttribute
  * DATA_IndexedFlag
  * DATA_VCNs
  * DATA_NonResidentFlag
  * DATA_CompressionUnitSize
  * HEADER_LSN
  * HEADER_RecordRealSize
  * HEADER_RecordAllocSize
  * HEADER_FileRef
  * HEADER_NextAttribID
  * DATA_AllocatedSize
  * DATA_RealSize
  * DATA_InitializedStreamSize
  * SI_HEADER_Flags
  * SI_MaxVersions
  * SI_VersionNumber
  * SI_ClassID
  * SI_OwnerID
  * SI_SecurityID
  * FN_CTime_2
  * FN_ATime_2
  * FN_MTime_2
  * FN_RTime_2
  * FN_AllocSize_2
  * FN_RealSize_2
  * FN_Flags_2
  * FN_NameLength_2
  * FN_NameType_2
  * FN_FileName_2
  * GUID_ObjectID
  * GUID_BirthVolumeID
  * GUID_BirthObjectID
  * GUID_BirthDomainID
  * VOLUME_NAME_NAME
  * VOL_INFO_NTFS_VERSION
  * VOL_INFO_FLAGS
  * FN_CTime_3
  * FN_ATime_3
  * FN_MTime_3
  * FN_RTime_3
  * FN_AllocSize_3
  * FN_RealSize_3
  * FN_Flags_3
  * FN_NameLength_3
  * FN_NameType_3
  * FN_FileName_3
  * DATA_Name_2
  * DATA_NonResidentFlag_2
  * DATA_Flags_2
  * DATA_LengthOfAttribute_2
  * DATA_IndexedFlag_2
  * DATA_StartVCN_2
  * DATA_LastVCN_2
  * DATA_VCNs_2
  * DATA_CompressionUnitSize_2
  * DATA_AllocatedSize_2
  * DATA_RealSize_2
  * DATA_InitializedStreamSize_2
  * DATA_Name_3
  * DATA_NonResidentFlag_3
  * DATA_Flags_3
  * DATA_LengthOfAttribute_3
  * DATA_IndexedFlag_3
  * DATA_StartVCN_3
  * DATA_LastVCN_3
  * DATA_VCNs_3
  * DATA_CompressionUnitSize_3
  * DATA_AllocatedSize_3
  * DATA_RealSize_3
  * DATA_InitializedStreamSize_3
  * STANDARD_INFORMATION_ON
  * ATTRIBUTE_LIST_ON
  * FILE_NAME_ON
  * OBJECT_ID_ON
  * SECURITY_DESCRIPTOR_ON
  * VOLUME_NAME_ON
  * VOLUME_INFORMATION_ON
  * DATA_ON
  * INDEX_ROOT_ON
  * INDEX_ALLOCATION_ON
  * BITMAP_ON
  * REPARSE_POINT_ON
  * EA_INFORMATION_ON
  * EA_ON
  * PROPERTY_SET_ON
  * LOGGED_UTILITY_STREAM_ON

= Explanation =

They should be quite self explanatory by their name, but anyways here's e few hints;
  * Those ending with a ON is just to indicate whether the attribute was used in the record.
  * Those ending with 2 or 3 or 4 are indicating they are number 2, 3 or 4 in the row of the same attribute on the same record.
  * Prefix of FN means $FILE_NAME.
  * Prefix of SI means $STANDARD_INFORMATION
  * Prefix of HEADER means the record header.
  * CTime means File Create Time.
  * ATime means File Modified Time.
  * MTime means MFT Entry modified Time.
  * RTime means File Last Access Time.
  * USN stands for Update Sequence Number.
  * LSN stands for $LogFile Sequence Number.
  * RecordOffset refers to the hex offset inside the $MFT itself, and not on the physical disk. Only meant as a helper when quickly looking up abnormalities found in the csv.
  * Signature refers to whether the record signature equals 0x46494C45 or not.
  * IntegrityCheck refers to a record integrity check by comparing the Update Sequence number to the record page (sector) end markers (2 bytes for each sector).
  * Those starting with GUID belongs to the $OBJECT_ID attribute.
  * Those starting with INVALID_FILENAME is when illegal characters are found in the filename. For example, sometimes control characters like line feeds etc exist in filename.

= Alternate Data Streams =

These streams can be identified in the second $DATA attribute. That is under those fields starting with DATA and ending with either 2 or 3. So if a second ADS is attached to a file, it will show up with the details under the third $DATA attribute. As far as I know there do not exist any limit on number of ADS's tied to a file.  For that reason, my limit on support for 3 $DATA attributes per file may miss out on those cases with more than 2 ADS's on the same file (not that I have seen this in multiple though). But to fix this I added a variable that counts the number of $DATA present. It is shown in the csv under Alternate_Data_Streams. Note that ADS's can only be attached to the $DATA attribute of a file. It is not possible to create ADS's on any of the other attributes. That may not be surpising as it should be obvious as it's named Alternate *Data* Stream, instead of Alternate File_Name Stream.

= Timestamps =

The timestamps are now at the precision of nanoseconds. Prior to processing, there is also an option to set how timestamps will be presented in the csv. That is in which UTC region the target system had. The configured setting is visible in the csv header, as well as in the logfile. The current format of the timestamp is April 19, 2009 03:45:57:140:2244. I recently created a new format like YYYY-MM-DD HH:MM:SS:MSMSMS:NSNSNSNS, which is more filter friendly in Excel. Options for more formats is also on the todo list, and I'm open for suggestions. The timestamps generated are corrected for any time bias on the investigating machine, which means the timezone configuration on the machine where mft2csv is run, should not affect output. There's also an option to directly adjust timestamps for any known timezone bias for images or $MFT taken from a different system. That means with a disk image from a system confgured at UTC -9.30 for instance, can be directly adjusted, so that timestamps are displayed in UTC 0.00.

= Note =

Resolved paths may not be correct for deleted files/folders. That is because its parent ref (or parents parents ref, etc) may have been overwritten with a new entry.

= Latest Version =

v2.0.0.4

= Changelog =

v2.0.0.4. Added functionality to parse broken $MFT. Added option to skip fixups.

v2.0.0.3. Fixed crash on certain MFT's with specific invalid records. Added option to choose separator, and if surrounding quotes. Removed decode of filename attribute number 4, as well as the invalid name variable.

v2.0.0.2. Speed improvement by 30 %. Fixed bug where some columns was missing in csv with the All format.

v2.0.0.1. Added support for choosing output format (all/default, log2timeline, bodyfile)

v2.0.0.0. Fixed bug that caused csv to be messed up when there where commas in filename. New features include support disk and partition images, live system analysis, logfile writer, nicer gui, paths resolved, option to choose any UTC region.

v1.0.0.10. Fixed old NT style records to reflect the text "NT style" in place of MFT reference.

v1.9. Added decode of hardlinks as specified in the record header. Corrected base record to properly reflect 6 bytes, and added new variable as base record sequence number for the last 2 bytes of this 8 byte MFT base reference. Fixed the HEADER_LSN and SI_USN to be specified in decimal (consistent views in Excel). Fixed missing clearing of 9 global variables.

v1.8. Changed the progress updating to use AdlibRegister, which increase performance.

v1.7. Removed the record slack option as it was not working. Fixed compilation issues on recent AutoIt version. Fixups was implemented in the previous version I believe.

v1.5 Changed record signature detection to:

46494C45 = GOOD (although FILE is strictly speaking the correct one)
44414142 = BAAD
00000000 = ZERO
all other = UNKNOWN

Added header flag interpretation:
0x9 = FILE+INDEX_SECURITY (ALLOCATED)
0xD = FILE+INDEX_OTHER (ALLOCATED)

Fixed crash on decoding of certain corrupt $MFT, by skipping decode of those records.

v1.4 Fixed a bug in the record signature evaluation. Added csv entry for record signature evaluation. Added record integrity check by comparing the Update Sequence number to the record page end markers (2 bytes at 2 places). Some other cosmetic changes.

v1.3 Added nanoseconds to the datetime variables. Changed default datetime format to "YYYY-MM-DD HH:MM:SS:MSMSMS:NSNSNSNS". MSecTest changed to evaluate the last 7 digits (msec + nsec). 64-bit support.

v1.2 Fixed timestamps where a 0 was erronously put in before the milliseconds. Modified version Ascend4nt's (_WinTimeFunctions1.au3) UDF is attached (where the error originated from). Also added an option to choose before processing whether to set timestamps in UTC or local time.

v1.1. Fixed a mixup of ContinueLoop with ContinueCase in the main record processing loop. The error lead to an infinite loop when ADS was more than 3 or $FILE_NAME more than 4 per file. Added a new variable to the csv as the file size (FileSizeBytes). Basically it is the $DATA size, but I thought it was better to have the file size put into one place instead of spread across two (resident vs non-resident). This is only for the first $DATA attribute.


= ToDo =

  * Move attribute header analysis out as a separate part.
  * Security attribute.
  * Group the data in a more sensible way.
  * Improve the speed.

= Thanks and credits =

  * AutoIt forums (KaFu & trancexx) where the starter code was provided; http://www.autoitscript.com/forum/topic/94269-mft-access-reading-parsing-the-master-file-table-on-ntfs-filesystems/
  * Ascend4nt's AutoIt wintimefunctions; http://sites.google.com/site/ascend4ntscode/
  * David Kovar's nice analyzeMFT.py python script; http://www.integriography.com/
  * jennico's extended hex to dec conversion AutoIt udf
  * The "ntfs-cmd" project; http://code.google.com/p/ntfs-cmd/
  * llewxam at the AutoIt forums